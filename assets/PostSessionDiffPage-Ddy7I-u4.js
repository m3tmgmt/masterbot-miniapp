import{r as d,j as e,c as b,a as h,b as g}from"./index-WG-X-atP.js";import{C as v,P as j,a as u,O as y,u as N,b as I}from"./body-zones-3d-DWMaaEv7.js";import{H as C}from"./Html-BvAfAIZI.js";function k(a,o){const s=a-o;return s>=3?"#22c55e":s>=1?"#86efac":s<=-3?"#ef4444":s<=-1?"#fca5a5":"#fbbf24"}function M(a,o){const s=Math.abs(a-o);return s===0&&a===0?0:s>=5?.65:s>=3?.5:s>=1?.35:.2}function w({zone:a,before:o,after:s,sliderValue:t}){const r=d.useRef(null),{invalidate:n}=N(),f=o+(s-o)*t,l=a.radius*(.5+f/10*.8),i=Math.abs(o-s);I(({clock:c})=>{if(!r.current||i<2)return;const p=1+Math.sin(c.getElapsedTime()*2)*.08;r.current.scale.setScalar(p),n()});const m=k(o,s),x=M(o,s);return o===0&&s===0?null:e.jsxs("mesh",{ref:r,position:a.position,children:[e.jsx("sphereGeometry",{args:[l,16,16]}),e.jsx("meshBasicMaterial",{color:m,transparent:!0,opacity:x,depthWrite:!1})]})}function D({zone:a,before:o,after:s}){if(o===0&&s===0)return null;const t=o-s,r=t>0?"-":t<0?"+":"",n=t>0?"#22c55e":t<0?"#ef4444":"#fbbf24";return e.jsx(C,{position:[a.position[0],a.position[1]+a.radius+.06,a.position[2]],center:!0,pointerEvents:"none",zIndexRange:[100,0],children:e.jsxs("div",{style:{padding:"2px 6px",borderRadius:"4px",backgroundColor:"rgba(0, 0, 0, 0.85)",color:n,fontSize:"10px",fontWeight:700,fontFamily:"monospace",whiteSpace:"nowrap",userSelect:"none"},children:[r,Math.abs(t)]})})}function _({diffData:a,sliderValue:o=0}){const s=d.useRef(null),t=d.useMemo(()=>{const r=new Map;for(const n of a)r.set(n.zoneId,n);return r},[a]);return e.jsxs(e.Fragment,{children:[e.jsx("ambientLight",{intensity:.5}),e.jsx("directionalLight",{position:[2,3,2],intensity:.7}),e.jsx("directionalLight",{position:[-1,2,-2],intensity:.3}),e.jsxs("group",{children:[e.jsx(j,{}),u.map(r=>{const n=t.get(r.zoneId);return n?e.jsx(w,{zone:r,before:n.before,after:n.after,sliderValue:o},r.zoneId):null}),u.map(r=>{const n=t.get(r.zoneId);return n?e.jsx(D,{zone:r,before:n.before,after:n.after},`label-${r.zoneId}`):null})]}),e.jsx(y,{ref:s,enablePan:!1,minDistance:2,maxDistance:5,minPolarAngle:Math.PI*.15,maxPolarAngle:Math.PI*.85,target:[0,.3,0],enableDamping:!0,dampingFactor:.1})]})}function S({diffData:a}){const[o,s]=d.useState(0),t=d.useMemo(()=>{let n=0,f=0,l=0;for(const i of a){if(i.before===0&&i.after===0)continue;const m=i.before-i.after;m>0?n++:m<0?f++:l++}return{improved:n,worsened:f,unchanged:l}},[a]),r=d.useCallback(n=>{s(parseFloat(n.target.value))},[]);return e.jsxs("div",{children:[e.jsx("div",{className:"rounded-xl overflow-hidden border",style:{height:"50vh",borderColor:"var(--plm-border)",backgroundColor:"var(--plm-bg)"},children:e.jsx(v,{camera:{position:[0,.5,3.5],fov:40},dpr:[1,1.5],gl:{antialias:!0,powerPreference:"low-power"},style:{width:"100%",height:"100%",touchAction:"none"},children:e.jsx(_,{diffData:a,sliderValue:o})})}),e.jsxs("div",{className:"mt-3 px-1",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-1",style:{color:"var(--plm-text-hint)"},children:[e.jsx("span",{children:"До сеанса"}),e.jsx("span",{children:"После сеанса"})]}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:o,onChange:r,className:"w-full",style:{accentColor:"var(--plm-btn-bg)"}})]}),e.jsxs("div",{className:"flex justify-center gap-4 mt-3 text-xs",style:{color:"var(--plm-text-hint)"},children:[e.jsxs("span",{style:{color:"#22c55e"},children:["● Улучшение (",t.improved,")"]}),e.jsxs("span",{style:{color:"#fbbf24"},children:["● Без изменений (",t.unchanged,")"]}),e.jsxs("span",{style:{color:"#ef4444"},children:["● Ухудшение (",t.worsened,")"]})]})]})}const z=[{zoneId:"lower_back",before:8,after:4},{zoneId:"lower_back_right",before:7,after:3},{zoneId:"trapezius_left",before:6,after:2},{zoneId:"trapezius_right",before:5,after:3},{zoneId:"neck_back",before:7,after:5},{zoneId:"scapula_left",before:4,after:1},{zoneId:"shoulder_left",before:3,after:3},{zoneId:"hamstring_left",before:5,after:2},{zoneId:"hamstring_right",before:4,after:2},{zoneId:"glute_left",before:3,after:1}];function F(){const a=b(),o=h(),s=g(),t=a.state??{},r=d.useMemo(()=>{if(!t.beforeZones||!t.afterZones)return z;const l=new Map(t.beforeZones.map(c=>[c.zoneId,c.intensity])),i=new Map(t.afterZones.map(c=>[c.zoneId,c.intensity])),m=new Set([...l.keys(),...i.keys()]),x=[];for(const c of m)x.push({zoneId:c,before:l.get(c)??0,after:i.get(c)??0});return x},[t.beforeZones,t.afterZones]),n=d.useMemo(()=>{let l=0;for(const i of r)l+=i.before-i.after;return l},[r]),f=!t.beforeZones||!t.afterZones;return e.jsxs("div",{className:"pb-20",children:[e.jsxs("div",{className:"p-4 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("button",{type:"button",onClick:()=>o(-1),className:"text-lg",style:{color:"var(--plm-text-link)"},children:"←"}),e.jsx("h1",{className:"text-xl font-bold",children:f?"3D Diff (Демо)":"3D Diff: До / После"})]}),t.sessionLabel&&e.jsx("p",{className:"text-sm ml-7",style:{color:"var(--plm-text-hint)"},children:t.sessionLabel})]}),f&&e.jsx("div",{className:"mx-4 mb-3 py-2 px-3 rounded-lg text-xs border",style:{backgroundColor:"var(--plm-bg-secondary)",color:"var(--plm-text-hint)",borderColor:"var(--plm-border)"},children:"Демонстрационные данные. Реальный diff будет доступен после сеанса."}),e.jsx("div",{className:"px-4",children:e.jsx(S,{diffData:r})}),e.jsx("div",{className:"px-4 mt-4",children:e.jsxs("div",{className:"rounded-xl border p-4",style:{borderColor:"var(--plm-border)",backgroundColor:"var(--plm-bg-secondary)"},children:[e.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Итог сеанса"}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"#22c55e"},children:n>0?`-${n}`:n}),e.jsx("div",{className:"text-xs mt-0.5",style:{color:"var(--plm-text-hint)"},children:"Изменение боли"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"var(--plm-text)"},children:r.filter(l=>l.before>0||l.after>0).length}),e.jsx("div",{className:"text-xs mt-0.5",style:{color:"var(--plm-text-hint)"},children:"Зон обработано"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",style:{color:"#22c55e"},children:r.filter(l=>l.before>l.after).length}),e.jsx("div",{className:"text-xs mt-0.5",style:{color:"var(--plm-text-hint)"},children:"Улучшено"})]})]})]})}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 backdrop-blur border-t p-4",style:{backgroundColor:"rgba(var(--plm-bg-rgb, 0, 0, 0), 0.95)",borderColor:"var(--plm-border)",paddingBottom:Math.max(16,s.bottom)},children:e.jsxs("div",{className:"flex gap-3 max-w-lg mx-auto",children:[e.jsx("button",{type:"button",className:"flex-1 py-2.5 rounded-lg text-sm font-medium",style:{backgroundColor:"var(--plm-bg-secondary)",color:"var(--plm-text-hint)"},onClick:()=>o("/history"),children:"История"}),e.jsx("button",{type:"button",className:"flex-1 py-2.5 rounded-lg text-sm font-medium",style:{backgroundColor:"var(--plm-btn-bg)",color:"var(--plm-text)"},onClick:()=>o("/"),children:"Новый сеанс"})]})})]})}export{F as PostSessionDiffPage};
